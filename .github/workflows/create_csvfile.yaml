name: JMeter Test Workflow

on:
  push:
    branches:
      - main  # Trigger on push to the main branch
  pull_request:
    branches:
      - main  # Trigger on pull request to the main branch

jobs:
  jmeter-test:
    runs-on: ubuntu-latest  # This is the environment for the job (Ubuntu)

    steps:
    # Step 1: Checkout the code from the repository
    - name: Checkout repository
      uses: actions/checkout@v2

    # Step 2: Install Java (required by JMeter)
    - name: Install OpenJDK 8
      uses: actions/setup-java@v2
      with:
        java-version: '8'
    
    # Step 3: Download and install JMeter
    - name: Install JMeter
      run: |
        wget https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.4.1.tgz
        tar -xvzf apache-jmeter-5.4.1.tgz
        sudo mv apache-jmeter-5.4.1 /opt/jmeter
        echo "export PATH=\$PATH:/opt/jmeter/bin" >> $GITHUB_ENV

    # Step 4: Install JMeter Plugins (using JMeter Plugin Manager)
    - name: Install JMeter Plugins
      run: |
        # Download and install the JMeter Plugins Manager
        wget https://jmeter-plugins.org/files/jmeter-plugins-manager-1.10.jar
        mv jmeter-plugins-manager-1.10.jar /opt/jmeter/lib/ext/
        cd  /opt/jmeter/bin/
        ./PluginsManagerCMD.sh install jpgc-dummy,jpgc-graphs-basic,jpgc-graphs-additional,jmeter-grpc-request

    # Step 5: Create CSV file
    - name: Create CSV file
      run: |
          # Get the most recently modified .jtl file
          latest_file=$(ls -t ./resultfileupload/*.jtl | head -n 1)

          # Output the latest file
          echo "Latest file: $latest_file"
        ./JMeterPluginsCMD.sh --generate-csv ./aggregated_report.csv  --input-jtl $latest_file --plugin-type AggregateReport --exclude-label-regex true --exclude-labels '.*\/.*|.*Token.*|.*BeanShell.*|bzm.*'

    # Step 6: Commit result files back to the repository
    - name: Commit result file
      uses: EndBug/add-and-commit@v7
      with:
        author_name: 'GitHub Actions'
        author_email: 'github-actions[bot]@users.noreply.github.com'
        message: 'Add result files generated by Python script'
        add: './*'

    # # Step 6: Upload JMeter Results (optional)
    # - name: Upload JMeter Results
    #   uses: actions/upload-artifact@v2
    #   with:
    #     name: jmeter-results
    #     path: result.jtl

    # - name: Upload JMeter Report
    #   uses: actions/upload-artifact@v2
    #   with:
    #     name: jmeter-report
    #     path: ./jmeter_report
